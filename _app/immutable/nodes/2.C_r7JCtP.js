import"../chunks/DsnmJJEf.js";import{i as Dt}from"../chunks/B4jtaNt1.js";import{l as kt,o as Pt,u as Y,v as R,x as h,q as I,t as xt,y as u,C as c,z as g,w as t,B as A,D as X,A as n,aa as jt,F as lt,G as Bt,m as Rt,n as _t,a8 as st,ab as Ut,I as F,T as gt}from"../chunks/B05C3QVk.js";import{d as a,e as bt,i as It,b as Xt,r as Gt,s as yt}from"../chunks/BI1NAbvE.js";import{i as dt}from"../chunks/qQCKdEnz.js";import{b as ht}from"../chunks/skLSM6bK.js";import{s as Kt}from"../chunks/BlywIX0I.js";import{p as Ot,s as qt,a as Jt}from"../chunks/CBnieVLF.js";import{a as zt}from"../chunks/D_HsOHAR.js";var Ht=Y('<div class="status export-status svelte-1cghwp"> </div>'),Vt=Y('<div class="status import-status svelte-1cghwp"> </div>'),Qt=Y('<div class="import-export-container svelte-1cghwp"><div class="button-group svelte-1cghwp"><button class="export-button svelte-1cghwp"> </button> <label class="import-button svelte-1cghwp"><input type="file" accept=".json" class="svelte-1cghwp"/> </label></div> <!> <!></div>');function Zt(nt,G){kt(G,!1);let $=A(!1),N=A(!1),_=A(""),b=A("");async function D(){const p=await a.welders.count(),m=await a.plans.count(),f=await a.norms.count(),i=await a.records.count(),O=await a.dailies.count();return p>0||m>0||f>0||i>0||O>0}async function k(){n($,!0),n(b,"Сбор данных...");try{const p=await a.welders.toArray(),m=await a.plans.toArray(),f=await a.norms.toArray(),i=await a.records.toArray(),O=await a.dailies.toArray();n(b,"Формирование файла...");const U={version:"1.0",exportDate:new Date().toISOString(),data:{welders:p,plans:m,norms:f,records:i,dailies:O}},J=JSON.stringify(U,null,2),P=new Blob([J],{type:"application/json"}),C=document.createElement("a");C.href=URL.createObjectURL(P),C.download=`welders_data_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(C),C.click(),document.body.removeChild(C),n(b,"Экспорт завершен!"),setTimeout(()=>{n(b,"")},3e3)}catch(p){console.error("Ошибка при экспорте:",p),n(b,"Ошибка экспорта!"),setTimeout(()=>{n(b,"")},3e3)}finally{n($,!1)}}async function K(p){const m=p.target.files?.[0];if(m){n(N,!0),n(_,"Чтение файла...");try{const f=await m.text(),i=JSON.parse(f);if(!i.data||!i.version)throw new Error("Неверный формат файла импорта");if(await D()){n(_,"Создание бэкапа...");const U=await a.welders.toArray(),J=await a.plans.toArray(),P=await a.norms.toArray(),C=await a.records.toArray(),z=await a.dailies.toArray(),tt={version:"1.0",exportDate:new Date().toISOString(),data:{welders:U,plans:J,norms:P,records:C,dailies:z}},et=JSON.stringify(tt,null,2),r=new Blob([et],{type:"application/json"}),s=document.createElement("a");s.href=URL.createObjectURL(r),s.download=`backup_welders_data_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s)}n(_,"Очистка базы данных..."),await a.transaction("rw",[a.welders,a.plans,a.norms,a.records,a.dailies],async()=>{await a.welders.clear(),await a.plans.clear(),await a.norms.clear(),await a.records.clear(),await a.dailies.clear()}),n(_,"Импорт данных..."),await a.transaction("rw",[a.welders,a.plans,a.norms,a.records,a.dailies],async()=>{i.data.welders&&i.data.welders.length>0&&await a.welders.bulkAdd(i.data.welders),i.data.plans&&i.data.plans.length>0&&await a.plans.bulkAdd(i.data.plans),i.data.norms&&i.data.norms.length>0&&await a.norms.bulkAdd(i.data.norms),i.data.records&&i.data.records.length>0&&await a.records.bulkAdd(i.data.records),i.data.dailies&&i.data.dailies.length>0&&await a.dailies.bulkAdd(i.data.dailies)}),n(_,"Импорт завершен! Перезагрузка страницы..."),setTimeout(()=>{window.location.reload()},2e3)}catch(f){console.error("Ошибка при импорте:",f),n(_,`Ошибка импорта: ${f instanceof Error?f.message:"Неизвестная ошибка"}`),setTimeout(()=>{n(_,"")},5e3)}finally{n(N,!1)}}}Pt(()=>{}),Dt();var W=Qt(),S=u(W),x=u(S),q=u(x,!0);c(x);var H=g(x,2),w=u(H),v=g(w);c(H),c(S);var V=g(S,2);{var Q=p=>{var m=Ht(),f=u(m,!0);c(m),R(()=>X(f,t(b))),I(p,m)};dt(V,p=>{t(b)&&p(Q)})}var ot=g(V,2);{var Z=p=>{var m=Vt(),f=u(m,!0);c(m),R(()=>X(f,t(_))),I(p,m)};dt(ot,p=>{t(_)&&p(Z)})}c(W),R(()=>{x.disabled=t($),X(q,t($)?"Экспорт...":"Экспорт"),w.disabled=t(N),X(v,` ${t(N)?"Импорт...":"Импорт"}`)}),h("click",x,k),h("change",w,K),I(nt,W),xt()}var te=Y('<div class="calendar-day empty svelte-2t4w62"></div>'),ee=Y('<span class="hours svelte-2t4w62"> </span>'),ae=Y('<div role="button" tabindex="0"><span class="day-number svelte-2t4w62"></span> <!></div>'),re=Y('<div class="calendar-nav svelte-2t4w62"><button>← Пред.</button> <span class="current-month-title svelte-2t4w62"> </span> <button>След. →</button></div> <div class="calendar-grid svelte-2t4w62"><!> <!></div>',1),se=Y('<p style="text-align: center; color: #888;">За этот период нет выполненных работ.</p>'),ne=Y('<div class="modal-overlay svelte-2t4w62" role="button" tabindex="0" aria-label="Закрыть окно"><div class="modal-content svelte-2t4w62" role="dialog" aria-labelledby="modal-title" tabindex="-1"><h3 id="modal-title" class="svelte-2t4w62"> </h3> <!> <div class="modal-actions svelte-2t4w62"><button class="cancel-button svelte-2t4w62">Закрыть</button></div></div></div>');function oe(nt,G){kt(G,!1);const $=()=>Jt(S,"$activatedDays",N),[N,_]=qt(),b=A(),D=A(),k=A(),K=A(),W=A();let S=zt,x=Ot(G,"welder",8,null),q=Ot(G,"show",8,!1);const H=jt();let w=A(new Map),v=A("");async function V(){if(!x())return;const r=await a.dailies.where("welderId").equals(x().id).toArray();Q(r);const s=Array.from(t(w).keys()).sort();s.length>0?n(v,s[s.length-1]):n(v,"")}function Q(r){const s=new Map,e=new Map;for(const o of r){const l=new Date(o.dateStr),y=ot(l);e.has(y)||e.set(y,new Map);const d=e.get(y),T=o.dateStr;d.set(T,(d.get(T)||0)+o.hours)}for(const[o,l]of e.entries()){const y=Array.from(l.entries()).map(([d,T])=>({date:new Date(d),hours:T}));y.sort((d,T)=>d.date.getTime()-T.date.getTime()),s.set(o,y)}n(w,s)}function ot(r){return`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`}function Z(r){return r.toFixed(2)}function p(r,s){return new Date(r,s+1,0).getDate()}function m(r,s){return new Date(r,s,1).getDay()}function f(){H("close")}function i(r){S.update(s=>s.indexOf(r)>-1?s.filter(o=>o!==r):[...s,r])}const O=400;let U;function J(r,s){if(r.button!==0)return;const e=P(s);U=window.setTimeout(()=>{i(e)},O);const o=()=>clearTimeout(U);r.target&&(r.target.addEventListener("pointerup",o,{once:!0}),r.target.addEventListener("pointercancel",o,{once:!0}))}function P(r){const s=r.getFullYear(),e=String(r.getMonth()+1).padStart(2,"0"),o=String(r.getDate()).padStart(2,"0");return`${s}-${e}-${o}`}function C(r){r.target===r.currentTarget&&f()}lt(()=>(st(q()),st(x())),()=>{q()&&x()&&V()}),lt(()=>(t(w),t(v)),()=>{n(b,t(w).get(t(v))||[])}),lt(()=>(t(D),t(k),t(v)),()=>{(r=>{var s=Ut(r,2);n(D,s[0]),n(k,s[1])})(t(v).split("-").map(Number))}),lt(()=>(t(D),t(k)),()=>{n(K,t(D)?p(t(D),t(k)-1):0)}),lt(()=>(t(D),t(k)),()=>{n(W,t(D)?m(t(D),t(k)-1):0)}),Bt(),Dt();var z=Rt(),tt=_t(z);{var et=r=>{var s=ne(),e=u(s),o=u(e),l=u(o);c(o);var y=g(o,2);{var d=L=>{var ut=re(),pt=_t(ut),ft=u(pt),mt=g(ft,2),Tt=u(mt,!0);c(mt);var At=g(mt,2);c(pt);var St=g(pt,2),Mt=u(St);bt(Mt,1,()=>(t(W),F(()=>Array(t(W)))),It,(E,j)=>{var at=te();I(E,at)});var Lt=g(Mt,2);bt(Lt,1,()=>(t(K),F(()=>Array(t(K)))),It,(E,j,at)=>{const B=gt(()=>new Date(t(D),t(k)-1,at+1)),$t=gt(()=>(st(t(B)),F(()=>t(B).getDay()))),vt=gt(()=>(t(b),st(t(B)),F(()=>t(b).find(M=>M.date.getFullYear()===t(B).getFullYear()&&M.date.getMonth()===t(B).getMonth()&&M.date.getDate()===t(B).getDate()))));var rt=ae();let Ct;var Et=u(rt);Et.textContent=at+1;var Yt=g(Et,2);{var Wt=M=>{var wt=ee(),Ft=u(wt);c(wt),R(Nt=>X(Ft,`${Nt??""}ч`),[()=>(st(t(vt)),F(()=>Z(t(vt).hours)))]),I(M,wt)};dt(Yt,M=>{t(vt)&&M(Wt)})}c(rt),R(M=>Ct=Kt(rt,1,"calendar-day svelte-2t4w62",null,Ct,M),[()=>({"has-work":t(vt),weekend:t($t)===0||t($t)===6,activated:$().includes(P(t(B)))})]),h("pointerdown",rt,M=>J(M,t(B))),h("keydown",rt,M=>M.key==="Enter"&&i(P(t(B)))),I(E,rt)}),c(St),R((E,j,at)=>{ft.disabled=E,X(Tt,j),At.disabled=at},[()=>(t(v),t(w),F(()=>t(v)===Array.from(t(w).keys()).sort()[0])),()=>(t(k),t(D),F(()=>t(k)?new Date(t(D),t(k)-1).toLocaleDateString("ru-RU",{year:"numeric",month:"long"}):"")),()=>(t(v),t(w),F(()=>t(v)===Array.from(t(w).keys()).sort()[Array.from(t(w).keys()).length-1]))]),h("click",ft,()=>{const E=Array.from(t(w).keys()).sort(),j=E.indexOf(t(v));j>0&&n(v,E[j-1])}),h("click",At,()=>{const E=Array.from(t(w).keys()).sort(),j=E.indexOf(t(v));j<E.length-1&&n(v,E[j+1])}),I(L,ut)},T=L=>{var ut=se();I(L,ut)};dt(y,L=>{t(w),F(()=>t(w).size>0)?L(d):L(T,!1)})}var ct=g(y,2),it=u(ct);c(ct),c(e),c(s),R(()=>X(l,`Календарь для: ${st(x()),F(()=>x().name)??""}`)),h("click",it,f),h("keydown",e,L=>L.key==="Escape"&&f()),h("click",s,C),h("keydown",s,L=>(L.key==="Enter"||L.key===" ")&&f()),I(r,s)};dt(tt,r=>{q()&&x()&&r(et)})}I(nt,z),xt(),_()}var ie=Y('<a class="welder-item svelte-1uha8ag" role="button" tabindex="0"> </a>'),le=Y('<div class="app-container svelte-1uha8ag"><header class="main-header svelte-1uha8ag"><h1 class="svelte-1uha8ag">Учёт сварщиков</h1> <div class="controls svelte-1uha8ag"><div class="add-welder svelte-1uha8ag"><input type="text" placeholder="Фамилия сварщика" class="svelte-1uha8ag"/> <button class="svelte-1uha8ag">Добавить</button></div> <!></div></header> <main class="main-content svelte-1uha8ag"><div class="welder-list svelte-1uha8ag"></div></main> <footer class="main-footer svelte-1uha8ag"><div class="nav-links svelte-1uha8ag"><a class="svelte-1uha8ag">План</a> <a class="svelte-1uha8ag">Нормы</a></div></footer></div> <!>',1);function ye(nt,G){kt(G,!1);let $=A(""),N=A([]),_=A(!1),b=A(null);async function D(){n(N,await a.welders.orderBy("name").toArray())}async function k(){if(t($).trim()===""){alert("Введите фамилию!");return}await a.welders.add({name:t($).trim()}),n($,""),await D()}const K=500,W=10,S=new Map;function x(e,o){if(e instanceof PointerEvent&&e.button&&e.button!==0)return;const l=e.pointerId,y=e.clientX??0,d=e.clientY??0;S.has(l)&&v(l);const T=window.setTimeout(()=>{const it=S.get(l);it&&(it.triggered=!0),Q(o)},K);S.set(l,{timeoutId:T,startX:y,startY:d,triggered:!1});const ct=e.target;try{ct?.setPointerCapture?.(l)}catch{}}function q(e){const o=e.pointerId,l=S.get(o);if(!l)return;const y=Math.abs((e.clientX??0)-l.startX),d=Math.abs((e.clientY??0)-l.startY);(y>W||d>W)&&v(o)}function H(e){const o=e.pointerId,l=S.get(o);if(!l)return;const y=l.triggered;v(o);const d=e.target;try{d?.releasePointerCapture?.(o)}catch{}y&&e.target?.addEventListener("click",V,{capture:!0,once:!0})}function w(e){v(e.pointerId)}function v(e){const o=S.get(e);o&&(o.timeoutId!=null&&clearTimeout(o.timeoutId),S.delete(e))}function V(e){e.stopImmediatePropagation(),e.preventDefault()}function Q(e){n(b,e),n(_,!0)}function ot(){n(_,!1),n(b,null)}Pt(()=>{D()}),Dt();var Z=le(),p=_t(Z),m=u(p),f=g(u(m),2),i=u(f),O=u(i);Gt(O);var U=g(O,2);c(i);var J=g(i,2);Zt(J,{}),c(f),c(m);var P=g(m,2),C=u(P);bt(C,5,()=>t(N),e=>e.id,(e,o)=>{var l=ie(),y=u(l,!0);c(l),R(()=>{yt(l,"href",`${ht??""}/welder/${t(o).id??""}`),X(y,t(o).name)}),h("pointerdown",l,d=>x(d,t(o))),h("pointermove",l,d=>q(d)),h("pointerup",l,d=>H(d)),h("pointercancel",l,d=>w(d)),h("keydown",l,d=>d.key==="Enter"&&Q(t(o))),I(e,l)}),c(C),c(P);var z=g(P,2),tt=u(z),et=u(tt),r=g(et,2);c(tt),c(z),c(p);var s=g(p,2);oe(s,{get welder(){return t(b)},get show(){return t(_)},set show(e){n(_,e)},$$events:{close:ot},$$legacy:!0}),R(()=>{yt(et,"href",`${ht??""}/plan`),yt(r,"href",`${ht??""}/norms`)}),Xt(O,()=>t($),e=>n($,e)),h("keydown",O,e=>e.key==="Enter"&&k()),h("click",U,k),I(nt,Z),xt()}export{ye as component};
