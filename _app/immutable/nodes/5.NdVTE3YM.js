import"../chunks/DsnmJJEf.js";import{i as St}from"../chunks/B4jtaNt1.js";import{l as $t,aa as At,F as ht,G as jt,u as K,x as O,q as L,t as qt,a8 as mt,w as t,B as E,y as c,z as h,A as v,C as o,v as it,I as j,D as V,al as Qt,ab as Ot,m as Lt,n as Tt,o as It,an as Ct,ao as Nt}from"../chunks/B05C3QVk.js";import{i as gt}from"../chunks/qQCKdEnz.js";import{b as Mt,r as Ft,e as Dt,s as Et,d as r}from"../chunks/BI1NAbvE.js";import{p as pt,s as Kt,a as Pt}from"../chunks/CBnieVLF.js";import{s as Bt}from"../chunks/HH3hefwB.js";import{a as Ht}from"../chunks/D_HsOHAR.js";import{b as Jt}from"../chunks/BnV46SC_.js";import{s as Wt,b as Yt}from"../chunks/CCkwdhXh.js";const zt=()=>{const B=Bt;return{page:{subscribe:B.page.subscribe},navigating:{subscribe:B.navigating.subscribe},updated:B.updated}},Gt={subscribe(B){return zt().page.subscribe(B)}};var Vt=K('<button class="suggestion-item svelte-1ml512p"><span class="suggestion-article svelte-1ml512p"> </span> <span class="suggestion-info svelte-1ml512p"> </span></button>'),Xt=K('<div class="suggestions-list svelte-1ml512p"></div>'),Zt=K('<div class="add-record svelte-1ml512p"><div class="input-with-suggestions svelte-1ml512p"><input type="text" placeholder="–ê—Ä—Ç–∏–∫—É–ª" class="svelte-1ml512p"/> <!></div> <input id="quantity-input" type="number" step="0.01" placeholder="–ö–æ–ª-–≤–æ" class="svelte-1ml512p"/> <button class="svelte-1ml512p">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button></div>');function te(B,q){$t(q,!1);let X=pt(q,"activePlans",24,()=>[]),f=pt(q,"newArticle",12),H=pt(q,"newQuantity",12);const lt=At();let A=E(!1),T=E([]);function S(s){return s.toFixed(2).replace(/\.?0+$/,"")}function k(s){f(s),v(A,!1),document.getElementById("quantity-input")?.focus()}function z(){lt("add",{article:f(),quantity:H()})}ht(()=>(mt(f()),t(T),mt(X())),()=>{f().trim()!==""?(v(T,X().filter(s=>s.article.toLowerCase().includes(f().toLowerCase()))),v(A,t(T).length>0)):(v(T,[]),v(A,!1))}),jt(),St();var Z=Zt(),U=c(Z),J=c(U);Ft(J);var R=h(J,2);{var P=s=>{var l=Xt();Dt(l,5,()=>t(T),g=>g.id,(g,i)=>{var m=Vt(),I=c(m),ct=c(I,!0);o(I);var tt=h(I,2),W=c(tt);o(tt),o(m),it((w,Y)=>{V(ct,(t(i),j(()=>t(i).article))),V(W,`${w??""}/${Y??""}—à—Ç`)},[()=>(t(i),j(()=>S(t(i).completed))),()=>(t(i),j(()=>S(t(i).quantity)))]),O("click",m,()=>k(t(i).article)),L(g,m)}),o(l),L(s,l)};gt(R,s=>{t(A)&&s(P)})}o(U);var d=h(U,2);Ft(d);var n=h(d,2);o(Z),Mt(J,f),O("focus",J,()=>v(A,f().trim()!=="")),Mt(d,H),O("keydown",d,s=>s.key==="Enter"&&z()),O("click",n,z),L(B,Z),qt()}var ee=K('<span class="updated-date svelte-j936dj"> </span>'),ae=K('<div class="record-item svelte-j936dj" role="button" tabindex="0"><button class="article-button svelte-j936dj"> </button> <span class="quantity svelte-j936dj"> </span> <div class="date-info svelte-j936dj"><span class="date svelte-j936dj"> </span> <!></div></div>'),ne=K('<div class="month-block svelte-j936dj"><h3 class="month-header svelte-j936dj"> </h3> <!></div>'),se=K('<div class="record-list svelte-j936dj"><h2 class="svelte-j936dj">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</h2> <!></div>');function re(B,q){$t(q,!1);const X=E();let f=pt(q,"records",24,()=>[]),H=pt(q,"allPlans",24,()=>[]);const lt=At();function A(n){return n.toFixed(2).replace(/\.?0+$/,"")}function T(n){if(!n||n.length===0)return new Map;const s=[...n].sort((g,i)=>{const m=g.lastUpdated?new Date(g.lastUpdated).getTime():new Date(g.date).getTime();return(i.lastUpdated?new Date(i.lastUpdated).getTime():new Date(i.date).getTime())-m}),l=new Map;for(const g of s){const i=new Date(g.date),m=`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}`;l.has(m)||l.set(m,[]),l.get(m).push(g)}return l}function S(n){const s=H().find(l=>l.article===n.article);return s&&s.isUnlimited?"—á":"—à—Ç"}let k;function z(n,s){k=window.setTimeout(()=>{R(s)},500)}function Z(n,s){clearTimeout(k),(n.button===0||n.pointerType==="touch")&&n.target.closest(".article-button")&&J(s.article)}function U(){clearTimeout(k)}function J(n){lt("selectArticle",{article:n})}function R(n){lt("openModal",{record:n})}ht(()=>mt(f()),()=>{v(X,T(f()))}),jt(),St();var P=se(),d=h(c(P),2);Dt(d,1,()=>(t(X),j(()=>Array.from(t(X).entries()))),([n,s])=>n,(n,s)=>{var l=Qt(()=>Ot(t(s),2));let g=()=>t(l)[0],i=()=>t(l)[1];var m=ne(),I=c(m),ct=c(I,!0);o(I);var tt=h(I,2);Dt(tt,1,i,W=>W.id,(W,w)=>{var Y=ae(),x=c(Y),C=c(x,!0);o(x);var nt=h(x,2),st=c(nt);o(nt);var dt=h(nt,2),rt=c(dt),vt=c(rt,!0);o(rt);var wt=h(rt,2);{var ft=_=>{var N=ee(),et=c(N);o(N),it(kt=>V(et,`–∏–∑–º: ${kt??""}`),[()=>(t(w),j(()=>new Date(t(w).lastUpdated).toLocaleDateString("ru-RU")))]),L(_,N)};gt(wt,_=>{t(w),j(()=>t(w).lastUpdated&&new Date(t(w).lastUpdated).getTime()!==new Date(t(w).date).getTime())&&_(ft)})}o(dt),o(Y),it((_,N,et)=>{V(C,(t(w),j(()=>t(w).article))),V(st,`${_??""}${N??""}`),V(vt,et)},[()=>(t(w),j(()=>A(t(w).quantity))),()=>(t(w),j(()=>S(t(w)))),()=>(t(w),j(()=>new Date(t(w).date).toLocaleDateString("ru-RU")))]),O("pointerdown",Y,_=>z(_,t(w))),O("pointerup",Y,_=>Z(_,t(w))),O("pointercancel",Y,U),O("keydown",Y,_=>_.key==="Enter"&&R(t(w))),L(W,Y)}),o(m),it(W=>V(ct,W),[()=>(g(),j(()=>new Date(g()+"-01").toLocaleDateString("ru-RU",{year:"numeric",month:"long"})))]),L(n,m)}),o(P),L(B,P),qt()}var oe=K('<span class="history-note svelte-3upjo2"> </span>'),ie=K('<div class="history-item svelte-3upjo2"><span class="history-date svelte-3upjo2"> </span> <span class="history-change svelte-3upjo2"> <!></span></div>'),le=K('<div class="modal-overlay svelte-3upjo2" role="button" tabindex="0"><div class="modal-content svelte-3upjo2" role="dialog" aria-labelledby="modal-title" tabindex="-1"><h3 id="modal-title" class="svelte-3upjo2"> </h3> <div class="edit-section svelte-3upjo2"><label for="edit-quantity-input" class="svelte-3upjo2">–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label> <input id="edit-quantity-input" type="number" step="0.01" class="svelte-3upjo2"/></div> <div class="history-section svelte-3upjo2"><h4 class="svelte-3upjo2">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:</h4> <div class="history-list svelte-3upjo2"></div></div> <div class="modal-actions svelte-3upjo2"><button class="save-button svelte-3upjo2">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button> <button class="delete-button svelte-3upjo2">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button> <button class="cancel-button svelte-3upjo2">–û—Ç–º–µ–Ω–∞</button></div></div></div>');function ce(B,q){$t(q,!1);const X=E();let f=pt(q,"selectedRecord",8,null),H=pt(q,"plan",8,null),lt=pt(q,"show",8,!1);const A=At();let T=E("");function S(d){if(!d||!d.history)return[];const n=JSON.parse(d.history),s=[];let l=0;for(const g of n){const i=l,m=l+g.quantity;s.push({date:new Date(g.date),was:i,became:m,note:g.note||""}),l=m}return s.reverse()}function k(d){return d.toFixed(2).replace(/\.?0+$/,"")}function z(){if(!f()||!H())return;const d=parseFloat(String(t(T)).replace(",","."));if(isNaN(d)||d<0){alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!");return}const n=d-f().quantity,s=H().completed+n;if(s>H().quantity){alert(`–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å! –ò—Ç–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (${k(s)}—à—Ç) –ø—Ä–µ–≤—ã—Å–∏—Ç –ø–ª–∞–Ω (${k(H().quantity)}—à—Ç).`);return}A("save",{newQuantity:d,quantityDifference:n})}function Z(){f()&&confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å "${f().article}"?`)&&A("delete")}function U(){A("close")}ht(()=>mt(f()),()=>{f()&&v(T,f().quantity.toString())}),ht(()=>mt(f()),()=>{v(X,S(f()))}),jt(),St();var J=Lt(),R=Tt(J);{var P=d=>{var n=le(),s=c(n),l=c(s),g=c(l);o(l);var i=h(l,2),m=h(c(i),2);Ft(m),o(i);var I=h(i,2),ct=h(c(I),2);Dt(ct,5,()=>t(X),x=>x.date.toISOString(),(x,C)=>{var nt=ie(),st=c(nt),dt=c(st,!0);o(st);var rt=h(st,2),vt=c(rt),wt=h(vt);{var ft=_=>{var N=oe(),et=c(N);o(N),it(()=>V(et,`(${t(C),j(()=>t(C).note)??""})`)),L(_,N)};gt(wt,_=>{t(C),j(()=>t(C).note)&&_(ft)})}o(rt),o(nt),it((_,N,et)=>{V(dt,_),V(vt,`${N??""}—à—Ç --‚ñ∫ ${et??""}—à—Ç `)},[()=>(t(C),j(()=>t(C).date.toLocaleDateString("ru-RU"))),()=>(t(C),j(()=>k(t(C).was))),()=>(t(C),j(()=>k(t(C).became)))]),L(x,nt)}),o(ct),o(I);var tt=h(I,2),W=c(tt),w=h(W,2),Y=h(w,2);o(tt),o(s),o(n),it(()=>V(g,`–ó–∞–ø–∏—Å—å: ${mt(f()),j(()=>f().article)??""}`)),Mt(m,()=>t(T),x=>v(T,x)),O("click",W,z),O("click",w,Z),O("click",Y,U),O("click",s,Wt(function(x){Yt.call(this,q,x)})),O("keydown",s,x=>x.key==="Escape"&&U()),O("click",n,U),O("keydown",n,x=>x.key==="Enter"&&U()),L(d,n)};gt(R,d=>{lt()&&f()&&H()&&d(P)})}L(B,J),qt()}var de=K('<link rel="preconnect" href="https://fonts.googleapis.com  "/> <link rel="preconnect" href="https://fonts.gstatic.com  " crossorigin="anonymous"/> <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>',1),ue=K('<h1 class="svelte-wkmng"> </h1>'),pe=K('<h1 class="svelte-wkmng">–°–≤–∞—Ä—â–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω</h1>'),ve=K('<main class="svelte-wkmng"><!> <!> <!> <!> <div class="bottom-nav svelte-wkmng"><a class="svelte-wkmng">–¥–æ–º–æ–π ‚àÜ</a></div></main>');function $e(B,q){$t(q,!1);const X=()=>Pt(Gt,"$page",H),f=()=>Pt(T,"$activatedDays",H),[H,lt]=Kt(),A=E();let T=Ht,S,k=E(),z=E([]),Z=E([]),U=E(""),J=E(""),R=E(null),P=E(null),d=E(!1);const n=new Map;function s(e){let a;const b=new Promise(p=>a=p),u=n.get(e)||Promise.resolve();return n.set(e,u.then(()=>b)),Promise.resolve(()=>{a(),n.get(e)})}async function l(){if(v(k,await r.welders.get(parseInt(X().params.id,10))),!t(k)){console.error("–°–≤–∞—Ä—â–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!");return}S=t(k).id,v(z,await r.plans.toArray()),v(Z,await r.records.where("welderId").equals(S).reverse().sortBy("lastUpdated"))}function g(e){const a=e.getFullYear(),b=String(e.getMonth()+1).padStart(2,"0"),u=String(e.getDate()).padStart(2,"0");return`${a}-${b}-${u}`}function i(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`}function m(e){let a=new Date(e);for(a.setDate(a.getDate()+1);a.getDay()===0||a.getDay()===6;)a.setDate(a.getDate()+1);return a}async function I(e,a){return(await r.dailies.where({welderId:S,dateStr:a}).toArray()).reduce((u,p)=>u+p.hours,0)}async function ct(e){const a={},b=new Date(e.date),u=i(b),p=await r.dailies.where("welderId").equals(S).filter(y=>{const at=i(new Date(y.dateStr));return y.article===e.article&&at===u}).toArray();for(const y of p)a[y.dateStr]=(a[y.dateStr]||0)+y.hours;return a}async function tt(e,a,b={}){let u=a;const p=[],y=[...f()].sort((D,$)=>D.localeCompare($)),at=new Set(y),ot={};async function yt(D,$){const Q=await I(D,$),F=b[$]||0,G=ot[$]||0;let ut=Q-F+G;return ut<0&&(ut=0),ut}for(const D of y){if(u<=.01)break;const $=await yt(e,D),Q=Math.max(0,8-$);if(Q>0){const F=Math.min(u,Q);p.push({dateStr:D,hours:F}),ot[D]=(ot[D]||0)+F,u-=F}}let M=new Date;for(;u>.01;){const D=g(M);if(at.has(D)){M=m(M);continue}if(M.getDay()===0||M.getDay()===6){M=m(M);continue}const Q=await yt(e,D),F=Math.max(0,8-Q);if(F>0){const G=Math.min(u,F);p.push({dateStr:D,hours:G}),ot[D]=(ot[D]||0)+G,u-=G}M=m(M)}return p}async function W(e){const a=e.article,b=new Date(e.date),u=i(b);await r.dailies.where("welderId").equals(S).filter(p=>{const y=i(new Date(p.dateStr));return p.article===a&&y===u}).delete()}async function w(e){try{const{article:a,quantity:b}=e.detail,u=parseFloat(String(b).replace(",","."));if(a.trim()===""||isNaN(u)||u<=0){alert("–í–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!");return}const p=t(A).find(M=>M.article.toLowerCase()===a.trim().toLowerCase());if(!p){alert("–¢–∞–∫–æ–≥–æ –∞—Ä—Ç–∏–∫—É–ª–∞ –Ω–µ—Ç –≤ –∞–∫—Ç–∏–≤–Ω–æ–º –ø–ª–∞–Ω–µ –∏–ª–∏ –æ–Ω —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω!");return}if(!p.isUnlimited&&p.completed+u>p.quantity){alert(`–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å! –ü—Ä–µ–≤—ã—à–µ–Ω –ø–ª–∞–Ω –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É "${p.article}". –û—Å—Ç–∞–ª–æ—Å—å ${(p.quantity-p.completed).toFixed(2).replace(/\.?0+$/,"")}—à—Ç.`);return}const y=a.trim().toUpperCase(),at=await r.norms.where("article").equals(y).first();if(!at){alert(`–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–æ—Ä–º–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∞—Ä—Ç–∏–∫—É–ª–∞ "${y}"!`);return}const ot=u*at.time,yt=await s(S);try{const M=await tt(y,ot),D=new Map;for(const $ of M){const Q=new Date($.dateStr),F=i(Q),G=$.hours/at.time;D.set(F,(D.get(F)||0)+G)}await r.transaction("rw",[r.records,r.plans,r.dailies],async()=>{for(const $ of M)await r.dailies.add({welderId:S,article:y,dateStr:$.dateStr,hours:$.hours});for(const[$,Q]of D.entries()){const[F,G]=$.split("-").map(Number),ut=new Date(F,G-1,1),_t=await r.records.where({welderId:S,article:y}).and(xt=>{const bt=new Date(xt.date);return bt.getFullYear()===F&&bt.getMonth()===G-1}).first(),Ut={date:new Date().toISOString(),quantity:Q,note:`–î–æ–±–∞–≤–ª–µ–Ω–æ ${Q.toFixed(2)} —à—Ç`},Rt=new Date;if(_t){const xt=_t.quantity+Q,bt=[...JSON.parse(_t.history||"[]"),Ut];await r.records.update(_t.id,{quantity:xt,history:JSON.stringify(bt),lastUpdated:Rt})}else await r.records.add({welderId:S,article:y,quantity:Q,date:ut,history:JSON.stringify([Ut]),lastUpdated:Rt})}p.completed+=u,await r.plans.update(p.id,{completed:p.completed})})}finally{yt()}v(U,""),v(J,""),await l()}catch(a){console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏:",a),alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞! –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ (F12).")}}function Y(e){v(U,e.detail.article),document.getElementById("quantity-input")?.focus()}function x(e){v(R,e.detail.record),v(P,t(z).find(a=>a.article===t(R).article)||null),v(d,!0)}async function C(e){if(!t(R)||!t(P))return;const a=t(R),b=t(P),{newQuantity:u,quantityDifference:p}=e.detail;try{const y=a.article,at=await r.norms.where("article").equals(y).first();if(!at){alert(`–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–æ—Ä–º–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∞—Ä—Ç–∏–∫—É–ª–∞ "${y}"!`);return}const ot=a.quantity,yt=u*at.time,M=await ct(a);await W(a);const D=await s(S);try{const $=await tt(y,yt,M);await r.transaction("rw",[r.records,r.plans,r.dailies],async()=>{for(const ut of $)await r.dailies.add({welderId:S,article:y,dateStr:ut.dateStr,hours:ut.hours});const Q={date:new Date().toISOString(),quantity:p,note:`–ò–∑–º–µ–Ω–µ–Ω–æ —Å ${ot.toFixed(2).replace(/\.?0+$/,"")} –Ω–∞ ${u.toFixed(2).replace(/\.?0+$/,"")}`},F=[...JSON.parse(a.history||"[]"),Q],G=new Date;await r.records.update(a.id,{quantity:u,date:a.date,history:JSON.stringify(F),lastUpdated:G}),b.completed+=p,await r.plans.update(b.id,{completed:b.completed})})}finally{D()}st(),await l()}catch(y){console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:",y),alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞! –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ (F12).")}}async function nt(){if(!t(R)||!t(P))return;const e=t(R),a=t(P);try{await W(e),await r.transaction("rw",r.records,r.plans,async()=>{await r.records.delete(e.id),a.completed-=e.quantity,a.completed<0&&(a.completed=0),await r.plans.update(a.id,{completed:a.completed})}),st(),await l()}catch(b){console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:",b),alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞! –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ (F12).")}}function st(){v(d,!1),v(R,null),v(P,null)}It(()=>{l()}),ht(()=>t(z),()=>{v(A,t(z).filter(e=>e.isUnlimited||e.quantity>0&&e.completed<e.quantity))}),jt(),St();var dt=ve();Ct(e=>{var a=de();Nt(4),L(e,a)});var rt=c(dt);{var vt=e=>{var a=ue(),b=c(a);o(a),it(()=>V(b,`–ö–∞—Ä—Ç–æ—á–∫–∞ —Å–≤–∞—Ä—â–∏–∫–∞: ${t(k),j(()=>t(k).name)??""}`)),L(e,a)},wt=e=>{var a=pe();L(e,a)};gt(rt,e=>{t(k)?e(vt):e(wt,!1)})}var ft=h(rt,2);te(ft,{get activePlans(){return t(A)},get newArticle(){return t(U)},set newArticle(e){v(U,e)},get newQuantity(){return t(J)},set newQuantity(e){v(J,e)},$$events:{add:w},$$legacy:!0});var _=h(ft,2);re(_,{get records(){return t(Z)},get allPlans(){return t(z)},$$events:{selectArticle:Y,openModal:x}});var N=h(_,2);ce(N,{get selectedRecord(){return t(R)},get plan(){return t(P)},get show(){return t(d)},set show(e){v(d,e)},$$events:{save:C,delete:nt,close:st},$$legacy:!0});var et=h(N,2),kt=c(et);o(et),o(dt),it(()=>Et(kt,"href",`${Jt??""}/`)),L(B,dt),qt(),lt()}export{$e as component};
